<!-- core/templates/core/survey_result.html -->
{% load static %}

<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>نتایج نظرسنجی</title>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script src="{% static 'js/chart.min.js' %}"></script>
</head>
<body>
    <div class="container mt-5">
        <h2>نتایج نظرسنجی "{{ survey.title }}"</h2>
        {% for question, data in results.items %}
            <div class="mb-5">
                <h4>{{ question.question_text }}</h4>
                {% if question.question_type in 'poll ranking' %}
                    <canvas id="chart{{ forloop.counter }}"></canvas>
                    <script>
                        var ctx = document.getElementById('chart{{ forloop.counter }}').getContext('2d');
                        var chart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['{% for choice in data %}{{ choice.choice_text }},{% endfor %}'],
                                datasets: [{
                                    label: 'تعداد رای‌ها',
                                    data: ['{% for choice in data %}{{ choice.vote_count }},{% endfor %}'],
                                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    </script>
                {% elif question.question_type == 'word_cloud' %}
                    <div id="wordCloud{{ forloop.counter }}" style="width: 100%; height: 400px;"></div>
                    <script src="{% static 'js/d3.min.js' %}"></script>
                    <script src="{% static 'js/d3.layout.cloud.js' %}"></script>
                    <script>
                        var words = [
                           '{% for word, count in data.items %} ,{text: {{ word }}, size: {{ count }}},   {% endfor %}'
                        ];

                        var layout = d3.layout.cloud()
                            .size([800, 400])
                            .words(words.map(function(d) {
                                return {text: d.text, size: d.size * 10};
                            }))
                            .padding(5)
                            .rotate(0)
                            .fontSize(function(d) { return d.size; })
                            .on("end", draw);

                        layout.start();

                        function draw(words) {
                            d3.select("#wordCloud{{ forloop.counter }}").append("svg")
                                .attr("width", layout.size()[0])
                                .attr("height", layout.size()[1])
                              .append("g")
                                .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")")
                              .selectAll("text")
                                .data(words)
                              .enter().append("text")
                                .style("font-size", function(d) { return d.size + "px"; })
                                .style("fill", "steelblue")
                                .attr("text-anchor", "middle")
                                .attr("transform", function(d) {
                                  return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                                })
                                .text(function(d) { return d.text; });
                        }
                    </script>
                {% elif question.question_type == 'scale' %}
                    <p>میانگین: {{ data }}</p>
                {% elif question.question_type == 'video' %}
                    <iframe width="560" height="315" src="{{ data }}" frameborder="0" allowfullscreen></iframe>
                {% endif %}
            </div>
        {% endfor %}
    </div>
</body>
</html>
